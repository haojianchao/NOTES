<html>
<head>
  <title>week2-node-day02</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="694"/>
<h1>week2-node-day02</h1>

<div>
<span><div><font style="font-size: 14pt;">目标</font></div><div><font style="font-size: 14pt;">    电影列表 排序、按照区间查找功能、去重功能、搜索功能<br/></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;"><span>    复习：eval函数的使用场景、数组去重（至少你要懂得6种）</span><br/></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;">排序   ----  **.**.find().sort()   ------ （查询所有的数据，然后按照某一个字段进行排序）</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">var arr = [{a:1},{a:3},{a:2},{a:7},{a:4}];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">arr.sort((x,y)=&gt;{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return x.a - y.a;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">})</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">console.log(arr)</span></div></div><div><font style="font-size: 14pt;">    1、<font>movie.ejs中添加排序的路由，type表示按照什么进行排序，num表示升序还是降序，1表示升序，-1表示降序</font></font><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;a href = &quot;/sortMovieRoute?type=average&amp;num=1&quot;&gt;评分升序&lt;/a&gt;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;a href = &quot;/sortMovieRoute?type=average&amp;num=-1&quot;&gt;评分降序&lt;/a&gt;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;a href = &quot;/sortMovieRoute?type=year&amp;num=1&quot;&gt;上映时间升序&lt;/a&gt;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"> &lt;a href = &quot;/sortMovieRoute?type=year&amp;num=-1&quot;&gt;上映时间降序&lt;/a&gt;</span></font></div></div><div><font style="font-size: 14pt;"><font><span>    2、movie.js中定义路由 movie.<span style="font-size: 14pt;">sortMovieRoute</span></span><br/></font></font></div><div><font style="font-size: 14pt;"><font><span style="font-size: 14pt;"><span>    内部多加一层去重上映时间yearArr，应用的是node异步编程思想（后期所加的）</span><br/></span></font></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">sortMovieRoute: ( req, res, next) =&gt; {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { type, num } = url.parse( req.url, true ).query;</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//         var sortObj = {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//             &quot;year&quot;: num * 1</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//         }</span></font></font></div><div style="font-size: 14pt;"><font><font><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//          var sortObj = {}</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//         switch ( type ){</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//             case 'year':</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//                  sortObj = { year: num}</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//                 break;</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//             default:</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//                 break;</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">//         }</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var sortObj = {};// style.display   style['display']</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     </span><span style="font-family: Monaco; font-size: 9pt;"><font color="#E30000">   sortObj[type] = num*1;</font></span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall([</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongoUrl, ( err, db ) =&gt; {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          ( db, cb ) =&gt; {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              db.collection('movie').distinct('year', ( err, yearArr) =&gt; {</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  if ( err ) throw err;</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  cb( null, db, yearArr);</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              })</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          },</span></font></font></div><div style="font-size: 14pt;"><font><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, yearArr, cb ) =&gt; {</span></font></font></div><div><font><font><span style="font-family: Monaco;"><span style="color: rgb(51, 51, 51); font-size: 9pt;">                db.collection('movie').find( {}, {} ).</span><b><font style="font-size: 12pt;"><font color="#E30000">sort( sortObj )</font>.</font></b><span style="color: rgb(51, 51, 51); font-size: 9pt;">toArray( ( err, res ) =&gt; {</span></span></font></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, {</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res,</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                yearArr</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              });</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ],( err, result ) =&gt; {</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            var len = result.res.length;</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            res.render('movie', {</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                result:result.res,</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                len,</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                yearArr: result.yearArr</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            });</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></font></div><div style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></font></div></div><div><font style="font-size: 14pt;"><font><span><span>    3、注册路由 index.js</span><br/></span></font></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><font><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/sortMovieRoute', movie.sortMovieRoute);</span></font></font></div></div><div><font style="font-size: 14pt;"><font><span><span>    4、应用场景： ---- 分类页面</span><br/></span></font></font></div><div><font style="font-size: 14pt;"><font><span><span>    </span><span>    距离排序、价格排序、销量排序</span><br/></span></font></font></div><div><font style="font-size: 14pt;"><font><span><br/></span></font></font></div><div><span style="font-size: 14pt;">按照区间查找功能</span></div><div><span style="font-size: 14pt;"><span>    1、movie.ejs中添加路由，type表示依据哪个字段查询，min是最小值，max值是最大值</span><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;a href = &quot;/areaQueryMovieRoute?type=average&amp;min=9.4&amp;max=9.6&quot;&gt;查找平均分为9.4-9.6之间的数据&lt;/a&gt;</span></span></div></div><div><span style="font-size: 14pt;"><span><span>    2、定义路由 movie.<span style="font-size: 14pt;">areaQueryMovieRoute</span></span><br/></span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">areaQueryMovieRoute: ( req, res, next ) =&gt; {</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { type, min, max } = url.parse( req.url, true ).query;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var whereObj = {}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       </span><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000"> whereObj[type] = {</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">            $gte: min * 1,</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">            $lte: max * 1</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">        }</font></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall([</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongoUrl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              db.collection('movie').distinct('year', ( err, yearArr) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  cb( null, db, yearArr);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, yearArr, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('movie').find(</span> <span style="font-family: Monaco; font-size: 9pt;"><font color="#E30000">whereObj,</font></span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{} ).toArray( ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                yearArr</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ],( err, result ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            var len = result.res.length;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            res.render('movie', {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                result:result.res,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                len,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            yearArr: result.yearArr</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div></div><div><span style="font-size: 14pt;"><span><br/></span></span></div><div><span style="font-size: 14pt;"><span><span>    3、index.js中注册路由</span><br/></span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/areaQueryMovieRoute', movie.areaQueryMovieRoute);</span></span></div></div><div><span>    </span><br/></div><div><span style="font-size: 14pt;"><span><br/></span></span></div><div><span style="font-size: 14pt;"><span><span>    4、应用场景：   ----  分类页面</span><br/></span></span></div><div><span style="font-size: 14pt;"><span><span>    </span><span>    查找在500-1000元之间的产品</span><br/></span></span></div><div><font style="font-size: 14pt;"><font><span><br/></span></font></font></div><div><span style="font-size: 18.6667px;">去重功能 （查询所有的数据，只显示year，然后按照数组去重取得数据即可）</span></div><div><span>    </span><span>    1、页面显示数据</span><br/></div><div><img src="week2-node-day02_files/Image.png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;% for(var i = 0; i &lt; yearArr.length; i++ ){%&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;a href = &quot;/getYearMovie?year=&lt;%= yearArr[i] %&gt;&quot;&gt;&lt;%= yearArr[i] %&gt;&lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">             &lt;% }%&gt;</span></div></div><div><span style="font-size: 18.6667px;"><span>    2、定义路由----都是加在了其他路由中，nodejs异步编程串行有关联的第二个函数</span></span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"> ( cb ) =&gt; {</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongoUrl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      </span><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">    ( db, cb ) =&gt; {</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">              db.collection('movie').distinct('year', ( err, yearArr) =&gt; {</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">                  if ( err ) throw err;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">                  cb( null, db, yearArr);</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">              })</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">          },</font></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, yearArr, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('movie').find(</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(227, 0, 0);">whereObj,</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{} ).toArray( ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                yearArr</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div></div><div><span style="font-size: 18.6667px;"><span><span> </span>   </span></span></div><div><span style="font-size: 18.6667px;"><span> <span>    </span>4、应用场景 ----- 分类页面</span><br/></span></div><div><span style="font-size: 18.6667px;"><span><span>    </span><span>    品牌、产品数据多次重复只需要一次时</span><br/></span></span></div><div><font style="font-size: 14pt;"><font><span><br/></span></font></font></div><div><span style="font-size: 18.6667px;">搜索功能</span></div><div><span style="font-size: 18.6667px;"><span>    1、编写页面</span><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;div class=&quot;pull-right&quot;&gt;</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;input type=&quot;text&quot; placeholder='请输入电影名称搜索' id='searchInput' onchange = &quot;searchMovie()&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function searchMovie () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      var val = $(&quot;#searchInput&quot;).val();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      window.location.href = &quot;/searchMovie?title=&quot;+val</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><span style="font-size: 18.6667px;"><span><span>    2、定义路由  /title/  包含查询   /<span style="font-family: Monaco; color: rgb(227, 0, 0); font-size: 14pt; font-weight: bold;">^title/   以**开头查询</span>      ----  模糊查询</span><br/></span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">searchMovie: ( req, res, next ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       var { title } = url.parse( req.url, true ).query;</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       async.waterfall([</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           ( cb ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               MongoClient.connect( mongoUrl, ( err, db ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   if ( err ) throw err;</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   cb( null, db );</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               })</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           },</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           ( db, cb ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               db.collection('movie').distinct('year', ( err, yearArr) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   if ( err ) throw err;</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   cb( null, db, yearArr);</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               })</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           },</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           ( db, yearArr, cb ) =&gt; {</span></div><div><span style="font-size: 9pt; font-family: Monaco; color: rgb(51, 51, 51);">               db.collection('movie').find(</span> <span style="font-family: Monaco;"><font style="font-size: 14pt; color: rgb(227, 0, 0);"><b>{title: eval(&quot;/^&quot;+title+&quot;/&quot;)}</b></font></span><span style="font-size: 9pt; font-family: Monaco; color: rgb(51, 51, 51);">, {} ).toArray( ( err, res ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   if ( err ) throw err;</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   cb( null, {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                       res,</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                       yearArr</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   });</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   db.close();</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               })</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           }</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ],( err, result ) =&gt; {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           var len = result.res.length;</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           res.render('movie', {</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               result:result.res,</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               len,</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               yearArr: result.yearArr</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           });</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       })</span></div><div style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><span style="font-size: 18.6667px;"><span><span>    3、注册路由</span><br/></span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/searchMovie', movie.searchMovie);</span></span></div></div><div><span style="font-size: 18.6667px;"><span><span>    4、应用场景</span><br/></span></span></div><div><font style="font-size: 14pt;"><font><span><span>    </span><br/></span></font></font></div><div><font style="font-size: 14pt;"><font><span><br/></span></font></font></div><div><font style="font-size: 14pt;"><font><br/></font></font></div><div><font style="font-size: 14pt;"><font><br/></font></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;"><br/></font></div></div></span>
</div></body></html> 