<html>
<head>
  <title>week2-node-day03</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="774"/>
<h1>week2-node-day03</h1>

<div>
<span><div><span style="font-size: 12pt;">目标</span></div><div><span style="font-size: 12pt;">    实现后台管理系统的登录功能，</span></div><div><br/></div><div><span style="font-size: 12pt;">    在线制作流程图</span><a href="https://www.processon.com/" style="font-size: 12pt;">https://www.processon.com/</a></div><div><span style="font-size: 12pt;"><img src="week2-node-day03_files/Image.png" type="image/png" data-filename="Image.png"/></span></div><div><br/></div><div><span style="font-size: 12pt;">一、根据cookie可以随着http请求发送给服务端，可以在服务端通过req.cookies拿到所有的cookie组成的对象。我们用loginState=1来表示管理员是登录状态，改造index.js</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">var defaultRoute = ( req, res, next ) =&gt; {</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    // console.log( req.cookies )</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    // res.cookie('login', '1')</font></span></div><div><font style="font-size: 12pt;"><span style="font-family: Monaco; color: rgb(51, 51, 51);"> </span><span style="font-family: Monaco;"><font color="#E30000">   if (  req.cookies.loginState == '1') {</font></span></font></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        res.render('index');</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    } else {</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        res.render('login');</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    }</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">}</font></span></div></div><div><br/></div><div><span style="font-size: 12pt;">二、创建了login.ejs、从admin-lte模板中查找案例</span><a href="http://adminlte.la998.com/pages/examples/login.html" style="font-size: 12pt;">http://adminlte.la998.com/pages/examples/login.html</a></div><div><span style="font-size: 12pt;">注意此处有一个模块iceck,你需要它的css和js，表单post提交到路由adminLoginAction</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">npm i icheck</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;"><span style="font-family: Monaco; color: rgb(51, 51, 51);">&lt;form a</span><span style="font-family: Monaco;"><font style="color: rgb(227, 0, 0);">ction=&quot;/adminLoginAction&quot;</font></span> <span style="font-family: Monaco; color: rgb(51, 51, 51);">method=&quot;post&quot;&gt;</span></font></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;div class=&quot;form-group has-feedback&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;username&quot; placeholder=&quot;username&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;span class=&quot;glyphicon glyphicon-envelope form-control-feedback&quot;&gt;&lt;/span&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;div class=&quot;form-group has-feedback&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;input type=&quot;password&quot; class=&quot;form-control&quot; name = &quot;password&quot; placeholder=&quot;Password&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;div class=&quot;row&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;div class=&quot;col-xs-8&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">          &lt;div class=&quot;checkbox icheck&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">            &lt;label&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">              &lt;input type=&quot;checkbox&quot;&gt; Remember Me</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">            &lt;/label&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">          &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;!-- /.col --&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;div class=&quot;col-xs-4&quot;&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">          &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary btn-block btn-flat&quot;&gt;登录&lt;/button&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">        &lt;!-- /.col --&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">      &lt;/div&gt;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    &lt;/form&gt;</font></span></div></div><div><br/></div><div><span style="font-size: 16px;">三、定义路由</span></div><div><span style="font-size: 16px;">    先创建一个admin.js作为管理员的路由，在其内部创建<span style="font-size: 12pt; color: rgb(227, 0, 0); font-family: Monaco;">adminLoginAction，数据库提前插入数据</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 16px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">var url = require('url');</span></span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">var async = require('async');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">var { MongoClient } = require('mongodb');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">var mongourl = &quot;</span><a href="mongodb://localhost:27017/bk1803" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">mongodb://localhost:27017/bk1803</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot;;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">module.exports = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    defaultRoute: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     res.render('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">   </span><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000"> adminLoginAction: ( req, r</font></span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">es, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { username, password } = req.body;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall( [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongourl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('admin').find( { username, password }, {} ).toArray( ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( res.length &gt; 0 ){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        cb( null, 1)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    }else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        cb( null, 0)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ], ( err, result ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ( result == 1){</span> <span style="font-family: Monaco; font-size: 9pt;"><font color="#E30000">//登录成功</font></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.cookie('loginState', 1);/</span><span style="font-family: Monaco; font-size: 9pt;"><font color="#E30000">/设置前端cookie</font></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.cookie('loginState', 0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // res.render('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    adminLogOut: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        res.cookie('loginState', 0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        res.redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div></div><div><span style="font-size: 16px;">四、注册路由</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.post('/adminLoginAction', admin.adminLoginAction);</span></div></div><div><span style="font-size: 12pt;">5、退出</span></div><div><span style="font-size: 16px;">header.ejs</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;a href=&quot;</span><span style="font-family: Monaco; font-size: 9pt;"><font color="#E30000">/adminLogOut</font></span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot; class=&quot;btn btn-default btn-flat&quot;&gt;退出&lt;/a&gt;</span></div></div><div><span style="font-size: 12pt;">admin.js</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">adminLogOut: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        res.cookie('loginState', 0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        res.redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div>index.js</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/adminLogOut', admin.adminLogOut);</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 