<html>
<head>
  <title>week2-node-day01</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="692"/>
<h1>week2-node-day01</h1>

<div>
<span><div><span style="font-size: 14pt;">目标：</span></div><div><span style="font-size: 14pt;">        完成演员列表中的增删改功能<br/></span></div><div><span style="font-size: 14pt;">拓展：</span></div><div><span style="font-size: 14pt;">        disabled与readonly区别   type=hidden<br/></span></div><div><span style="font-size: 14pt;">        bootstrap 中的class = ‘sr-only’ ----  让元素变得不可见<br/></span></div><div><span style="font-size: 14pt;">        type='checkbox' 和 type = 'radio'的js获取和设置的方法<br/></span></div><div><span style="font-size: 14pt;">        js返回上一页的方法<br/></span></div><div><span style="font-size: 14pt;">        颜色的区别： RGB,CMYK,LAB,HSB<br/></span></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 18.6667px;">删：给按钮添加点击事件，传入唯一表示id，删除完成返回列表，传入limitNum和skipNum</span></div><div><span style="font-size: 18.6667px;">      定义路由模块</span><span style="font-size: 14pt;">casts.deleteCastRoute，实现模块，接收参数id、limitNum、skipNum</span><span style="font-size: 18.6667px;"><br/></span></div><div><span style="font-size: 18.6667px;"><span style="font-size: 14pt;">    依据id调用deleteOne函数删除该演员，删除成功重定向（</span><span style="font-size: 14pt;">res.redirect（）</span><span style="font-size: 14pt;">）<br/></span></span></div><div><span style="font-size: 18.6667px;"><span style="font-size: 14pt;">    注册路由（index.js中注册路由）<br/></span></span></div><div><span style="font-size: 18.6667px;"><span style="font-size: 14pt;">   </span> <span style="font-size: 14pt; font-weight: bold;">casts.ejs</span><span style="font-size: 14pt;">中删除方法定义与实现</span></span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;button class=&quot;btn btn-xs btn-danger&quot; onclick = &quot;</span><span style="font-family: Monaco; font-size: 9pt;"><font color="#BA00FF">deleteItem(&lt;%= result[i].id %&gt;, &lt;%= limitNum %&gt;, &lt;%= skipNum %&gt;)</font></span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot;&gt;删除&lt;/button&gt;</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function deleteItem ( id, limitNum, skipNum) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            console.log( id )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            window.location.href = '/deleteCastRoute?id='+id + '&amp;limitNum=' +limitNum+'&amp;skipNum='+skipNum;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div></div><div>    <font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">casts,js</span></font>中定义删除方法<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 18.6667px;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">deleteCastRoute: ( req, res, next ) =&gt; {</span></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        console.log( req.url )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { id, limitNum, skipNum } = url.parse( req.url, true ).query;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // res.redirect( '/' );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall( [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongourl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('casts').deleteOne( { id: id }, ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, 'ok');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ], ( err, result) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if( result == 'ok'){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                // console.log(&quot;1111111111111111111111&quot;+  req.url)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                skipNum = skipNum == 0 ? 0 : skipNum - 1</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                 res.redirect( '/castspaging?limitNum='+limitNum+'&amp;skipNum='+skipNum);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">    index.j</span></font><font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">s</span></font>注册路由<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/deleteCastRoute', casts.deleteCastRoute);</span></div></div><div><span style="font-size: 18.6667px;"><span style="font-size: 14pt;"><br/></span></span><br/></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">增：构建增加页面casts_add.ejs,定义路由模块casts.</span><span style="font-size: 14pt;">addCastRoute，配置路由（index.js中配置），给演员表单<span style="font-size: 14pt;">添加路由（post提交，后台post</span><span style="font-size: 14pt;">接收</span><span style="font-size: 14pt;">，req.body接收）</span></span></div><div><span style="font-size: 14pt;">casts_add.ejs，注意提交方式，注意表单的name属性</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;form class=&quot;form-horizontal&quot; method = <b>&quot;post&quot;</b> action = '/addCastsAction'&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;div class=&quot;box-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;label for=&quot;castsid&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员id&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name = &quot;id&quot; id=&quot;castsid&quot; placeholder=&quot;演员id&quot;&gt; </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsname&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员名字&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name = &quot;name&quot; id=&quot;castsname&quot; placeholder=&quot;演员名字&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsavatars&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员头像&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;url&quot; class=&quot;form-control&quot; name = &quot;img&quot; id=&quot;castsavatars&quot; placeholder=&quot;演员头像&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsalt&quot; class=&quot;col-sm-2 control-label&quot;&gt;alt&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;url&quot; class=&quot;form-control&quot; name = &quot;alt&quot; id=&quot;castsalt&quot; placeholder=&quot;alt&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;!-- /.box-body --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;div class=&quot;box-footer&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;label for=&quot;castsalt&quot; class=&quot;col-sm-2 control-label sr-only&quot;&gt;alt&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                            &lt;input type=&quot;submit&quot;class=&quot;btn btn-info&quot; value = &quot;添加&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;!-- /.box-footer --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/form&gt;</span></div></div><div><span style="font-size: 14pt;">casts.</span><span style="font-size: 14pt;">addCastRoute，casts.<span style="font-size: 9pt;"><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco; font-weight: bold;">addCastsAction</span></span></span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">addCastRoute: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        res.render('casts_add')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    addCastsAction: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        console.log( req.body )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var obj = req.body;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        obj.avatars = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　　　　　　&quot;small&quot;:obj.img,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　　　　　　&quot;large&quot;:obj.img,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　　　　　　&quot;medium&quot;:obj.img</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　　　　}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var insertObj = obj;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall( [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                //连接数据库，得到数据库</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongourl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    console.log( '数据库连接成功' )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //传递db</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                //给数据库中对用的集合（表）添加数据</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('casts').insert( insertObj, ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    console.log( 'insert success!' );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //告诉最后一个回调函数，传递参数</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, 'ok');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //关闭数据库</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ], ( err, result) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ( result == &quot;ok&quot;) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                // console.log(&quot;插入数据成功&quot;);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.redirect('/castspaging?limitNum=5&amp;skipNum=0');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div></div><div>index.js注册路由</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/addCastRoute', casts.addCastRoute);</span></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.<b>post(</b>'/addCastsAction', casts.addCastsAction);</span></font></div></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><span style="font-size: 18.6667px;">改：casts.ejs中创建编辑方法，创建页面casts_update.ejs,创建路由<span style="font-size: 14pt;">casts.updateCastsRoute（页面跳转，依据id请求数据，将数据返回给</span><span style="font-size: 18.6667px;">casts_update.ejs</span><span style="font-size: 14pt;">），</span><span style="font-size: 14pt;">casts.updateCastsAction（更新action），index.js注册路由</span></span></div><div><span style="font-size: 18.6667px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">casts.ejs</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;button class=&quot;btn btn-xs btn-warning&quot; onclick = &quot;updateItem(&lt;%= result[i].id %&gt;, &lt;%= limitNum %&gt;, &lt;%= skipNum %&gt;)&quot;&gt;编辑&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function updateItem ( id, limitNum, skipNum) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        console.log( id )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        window.location.href = '/updateCastsRoute?id='+id + '&amp;limitNum=' +limitNum+'&amp;skipNum='+skipNum;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><span style="font-size: 18.6667px;">casts_update.ejs</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;form class=&quot;form-horizontal&quot; method = &quot;post&quot; action = '/updateCastsAction'&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;div class=&quot;box-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;label for=&quot;castsid&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员id&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;input type=&quot;text&quot; readonly class=&quot;form-control&quot; <b>value=&quot;&lt;%= id %&gt;&quot;</b> name = &quot;id&quot; id=&quot;castsid&quot; placeholder=&quot;演员id&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                  &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsname&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员名字&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; <b>value=&quot;&lt;%= name %&gt;&quot; </b> name = &quot;name&quot; id=&quot;castsname&quot; placeholder=&quot;演员名字&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsavatars&quot; class=&quot;col-sm-2 control-label&quot;&gt;演员头像&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;url&quot; class=&quot;form-control&quot; name = &quot;img&quot;  <b>value=&quot;&lt;%= img %&gt;&quot;</b>  id=&quot;castsavatars&quot; placeholder=&quot;演员头像&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;label for=&quot;castsalt&quot; class=&quot;col-sm-2 control-label&quot;&gt;alt&lt;/label&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;input type=&quot;url&quot; class=&quot;form-control&quot; name = &quot;alt&quot; <b> value=&quot;&lt;%= alt %&gt;&quot;</b>  id=&quot;castsalt&quot; placeholder=&quot;alt&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;!-- /.box-body --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;div class=&quot;box-footer&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;label for=&quot;castsalt&quot; class=&quot;col-sm-2 control-label sr-only&quot;&gt;alt&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;div class=&quot;col-sm-10&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                            &lt;input type=&quot;submit&quot;class=&quot;btn btn-info&quot; value = &quot;更新&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;input <b>type=&quot;hidden&quot; </b> value = &quot;&lt;%= limitNum %&gt;&quot; name=&quot;limitNum&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;input <b>type=&quot;hidden&quot;</b>  value = &quot;&lt;%= skipNum %&gt;&quot; name=&quot;skipNum&quot;/&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">              &lt;!-- /.box-footer --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/form&gt;</span></div></div><div><span style="font-size: 14pt;">casts.updateCastsRoute</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">updateCastsRoute: ( req, res, next ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { id, limitNum, skipNum } = url.parse( req.url, true ).query;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall( [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongourl, ( err, db ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('casts').find( {id: id}, {_id: 0} ).toArray( ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, res );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.close();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ], ( err, result ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //此处拿到的是只有一个元素的数组，所以为result[0]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            var { id, name, alt } = result[0];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            var img = result[0].avatars.small</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            res.render('casts_update', {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                id,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                name,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                alt,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                img,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                limitNum,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                skipNum</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // res.render('casts_update')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    updateCastsAction: ( req, res, next) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var obj = req.body;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        obj.avatars = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　&quot;small&quot;:obj.img,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　&quot;large&quot;:obj.img,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　　　　&quot;medium&quot;:obj.img</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">　　　　 };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var whereObj = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            id: obj.id</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var updateObj = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $set: {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                id: obj.id,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                avatars: obj.avatars,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                name: obj.name,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                alt: obj.alt</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        };</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        async.waterfall( [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                MongoClient.connect( mongourl, ( err, db ) =&gt;{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                   cb( null, db );</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ( db, cb ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                db.collection('casts').updateOne( whereObj, updateObj, ( err, res ) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    cb( null, 'ok');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ], ( err, result ) =&gt;{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ( err ) throw err;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if( result == 'ok') {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                // res.send('&lt;script&gt; history.go(-2); location.reload()&lt;/script&gt;')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                var skipNum = obj.skipNum == 0 ? 0 : obj.skipNum - 1;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.redirect('/castspaging?limitNum='+obj.limitNum+'&amp;skipNum='+skipNum);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;">index.js注册路由</span></span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.get('/updateCastsRoute', casts.updateCastsRoute);</span></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">router.post('/updateCastsAction', casts.updateCastsAction);</span></font></div></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;">完善分页功能</span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;">    参数为负值 ，内部添加判断语句</span></span></font><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">pagingRoute: ( req, res, next) =&gt; {</span></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        var { limitNum, skipNum } = url.parse( req.url, true ).query;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        limitNum = limitNum * 1 || 5;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        skipNum = skipNum * 1 || 0;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//         limitNum = limitNum &lt;= 0 ? 5 : limitNum;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">//         skipNum = skipNum &lt;= 0 ? 0 : skipNum;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       <b> if ( limitNum &lt;=0 || skipNum &lt; 0) {</b></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><b>            res.redirect('/castspaging?limitNum=5&amp;skipNum=0')</b></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><b>        }else{</b></span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            async.waterfall( [</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                ( cb ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    MongoClient.connect( mongourl, ( err, db ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        if ( err ) throw err;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        cb( null, db );</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    })</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                },</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                ( db, cb ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //mongodb 处理分页</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    //                 db.collection('casts').find( {}, {} ).limit( limitNum ).skip( limitNum * skipNum ).toArray( ( err, res ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    //                     if ( err ) throw err;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    //                     cb( null, res );</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    //                     db.close();</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    //                 })</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //js处理分页  - --  </span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //拿到全部的数据，res</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //求得全部数据的长度 listLen</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    //截取当前页面的数据 data     res.splice()   ----  返回的是截取的数据</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    db.collection('casts').find( {}, {} ).toArray( ( err, res ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        if ( err ) throw err;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        var listLen = res.length;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        //从哪开始截取，截取多少个，对应的是mongodb中的limit()和skip()</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        var data = res.splice( limitNum * skipNum,  limitNum );</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        </span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        cb( null, {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            listLen,</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            data</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        })</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        db.close();</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    })</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                }</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            ], ( err, result ) =&gt; {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                /**</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                 * var { listLen, data } = result;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                 listLen代表其这个数据库集合中所有数据的个数</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                 data:当前页面所对应的数据列表</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                 */</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                var len = result.data.length; // 前端循环遍历数据的条件</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                var totalNum = Math.ceil( result.listLen / limitNum ); //总共有多少页数据</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                skipNum = skipNum + 1;</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                res.render('casts', {</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    result: result.data,</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    len,</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    totalNum,</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    skipNum,</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    limitNum</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                });</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            })</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></font></div><div><font style="font-size: 14pt;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></font></div></div><div><br/></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font><br/></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt;"><span style="font-size: 14pt;"><br/></span></span></font></div></span>
</div></body></html> 